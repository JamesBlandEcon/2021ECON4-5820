

# Behavioral econometrics

## Example dataset

```{r}
library(foreign)
library(ggplot2)
Hey2001<- read.csv("../2021ECON5820/Hey2001.csv")

knitr::kable(head(Hey2001))
```

* decisions over 2 lotteries. $p$ or $q$
* $y=1$ iff $i$ chooses the q-lottery in decision $t$
* prizes: 0, 50, 100, 150 pounds

## Risk neutral

Maximization problem
$$
\max_l\{E[u(X\mid l)]\}
$$

Probabilistic choice function. Given choice set $\mathbb A$ (softmax)
$$
\Pr\left(l\right)\propto \exp\left(\lambda E[u(x)\mid l]\right)
$$



* As the utility of one action increases, I am more likely to take it.
* Interpretations
  + I make mistakes, but I recognize big payoff differences better than small ones
  + There is a random component to my utility (observed by the decision-maker but not econometrician)
  + There is a component of my utility that is not modeled well by $E[u(x)\mid l]$
  
Since we have only 2 choices, this becomes:
  
$$
\begin{aligned}
\Pr(y=1\mid p,q)&=\frac{\exp(\lambda E[u(x)\mid q])}{\exp(\lambda E[u(x)\mid q])+\exp(\lambda E[u(x)\mid p])}\\
&=\left(1+\exp\left(\lambda\left(E[u(x)\mid p]-E[u(x)\mid q]\right)\right)\right)^{-1}
\end{aligned}
$$

log-likeihood function:
$$
\mathcal L(\theta)=\sum_{t=1}^T\Pr(y_t\mid p_y,q_t)
$$

For risk-neutral: $u(x)=x$


```{r}

library(dplyr)

D<-(Hey2001
    %>% mutate(EVq = 0*q1+50*q2+100*q3+150*q4,
               EVp = 0*p1+50*p2+100*p3+150*p4
    )
    %>% mutate(DEV = EVq-EVp)
)
head(D)



```


Define and maximize likelihood:
```{r}

LL<-function(lambda,DEV,y) {
  # somthing in here to change DEV to DEU
  sum(-log(1+exp((-1)^y*lambda*DEV)))
}

LL(1,D$DEV,D$y)

lambdaHat<- optimize(function(x) {-LL(x,D$DEV,D$y)}, c(0, 1))

print(lambdaHat)

```

## Estimate a $\lambda_i$ for every subject (split by ID)
```{r}
lambdaHat<-function(DEV,y) {
  optimize(function(x) {-LL(x,DEV,y)}, c(0, 1))$minimum
}

print(lambdaHat(D$DEV,D$y))

LambdaHatEstimates<-(D
                     %>% group_by(id)
                     %>% summarize(lhat = lambdaHat(DEV,y)))


LambdaHatEstimates %>% head() %>% knitr::kable()

(
  ggplot(LambdaHatEstimates,aes(x=lhat))
  +stat_ecdf()
)
```

In context:
$$
\Pr(\text{chooses y to max DEV})=(1+\exp(-\lambda |\mathrm{DEV}|)^{-1}
$$
on average, a subject will choose the "right" action with probability
$$
\frac{1}{T}\sum_{t=1}^T(1+\exp(-\lambda |\mathrm{DEV}_t|)^{-1}
$$
```{r}
LogitResponse<-function(l,DEV) {
  mean(1/(1+exp(-l*abs(DEV))))
}
EVloss<-function(l,DEV) {
  p<-(1/(1+exp(-l*abs(DEV))))
  
  mean(p*0+(1-p)*abs(DEV))
}


LambdaHatEstimates<-(D
  %>% left_join(LambdaHatEstimates,by="id")
  %>% group_by(id)
  %>% summarize(PrHat = LogitResponse(lhat,DEV),
                EVloss = EVloss(lhat,DEV),
                lhat = mean(lhat))
)

LambdaHatEstimates %>% head() %>% knitr::kable()

(
  ggplot(LambdaHatEstimates,aes(x=PrHat))+stat_ecdf()
)

(
  ggplot()
  +stat_ecdf(data=LambdaHatEstimates,aes(x=EVloss,color="Estimated expected loss"))
  +stat_ecdf(data=D %>% filter(id==1),aes(x=abs(DEV),color="Theoretical max"))
  +xlab("Expected loss relative to EV-maximizing (pounds)")
)

```

## To do


* Add in risk aversion $u(x)=x^r$ ($r>0$). *suggestion* Estimate $\log r$ and $\log \lambda$ directly, then transform